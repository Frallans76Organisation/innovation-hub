stages:
  - test
  - build
  - deploy

variables:
  # Docker image settings
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

  # Kubernetes settings
  KUBE_NAMESPACE: innovation-hub

# Cache pip packages
cache:
  paths:
    - .cache/pip

# Run tests before building
test:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install --cache-dir .cache/pip -r requirements.txt
  script:
    - echo "Running tests..."
    # Add your test commands here
    # - pytest tests/
    - python -c "import innovation_hub; print('Import test passed')"
  only:
    - merge_requests
    - main
    - develop

# Build and push Docker image
build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    # Login to GitLab Container Registry
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building Docker image..."
    - docker build -t $IMAGE_NAME:$IMAGE_TAG -t $IMAGE_NAME:latest .
    - echo "Pushing Docker image..."
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker push $IMAGE_NAME:latest
    - echo "Image pushed: $IMAGE_NAME:$IMAGE_TAG"
  only:
    - main
    - develop
    - tags

# Deploy to OpenShift via ArgoCD
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl git
  script:
    - echo "Updating image tag in kustomization.yaml..."
    - sed -i "s|newTag:.*|newTag: $IMAGE_TAG|g" k8s/kustomization.yaml

    # Commit and push the change (ArgoCD will detect and deploy)
    - git config --global user.email "gitlab-ci@example.com"
    - git config --global user.name "GitLab CI"
    - git add k8s/kustomization.yaml
    - git commit -m "Update image tag to $IMAGE_TAG [skip ci]" || echo "No changes to commit"
    - git push https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:main

    - echo "Deployment triggered via GitOps. ArgoCD will sync automatically."
  environment:
    name: production
    url: https://innovation-hub.apps.your-cluster.example.com
  only:
    - main
  when: manual  # Require manual approval for production

# Alternative: Deploy directly to OpenShift (without ArgoCD)
deploy:direct:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  before_script:
    # Install oc CLI
    - curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
    - tar -xzf openshift-client-linux.tar.gz
    - mv oc /usr/local/bin/
    - chmod +x /usr/local/bin/oc

    # Login to OpenShift
    - oc login --token=$OPENSHIFT_TOKEN --server=$OPENSHIFT_SERVER --insecure-skip-tls-verify=true
    - oc project $KUBE_NAMESPACE || oc new-project $KUBE_NAMESPACE
  script:
    - echo "Deploying to OpenShift..."

    # Update image tag in deployment
    - sed -i "s|newTag:.*|newTag: $IMAGE_TAG|g" k8s/kustomization.yaml

    # Apply manifests
    - oc apply -k k8s/

    # Wait for rollout
    - oc rollout status deployment/innovation-hub -n $KUBE_NAMESPACE --timeout=5m

    - echo "Deployment completed successfully!"
    - echo "Application URL: https://$(oc get route innovation-hub -n $KUBE_NAMESPACE -o jsonpath='{.spec.host}')"
  environment:
    name: production
    url: https://innovation-hub.apps.your-cluster.example.com
  only:
    - main
  when: manual
  # Comment out this job if using ArgoCD
  rules:
    - when: never  # Disabled by default - enable if not using ArgoCD

# Tag images for releases
tag:release:
  stage: deploy
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - docker pull $IMAGE_NAME:latest
    - docker tag $IMAGE_NAME:latest $IMAGE_NAME:$CI_COMMIT_TAG
    - docker push $IMAGE_NAME:$CI_COMMIT_TAG
  only:
    - tags
